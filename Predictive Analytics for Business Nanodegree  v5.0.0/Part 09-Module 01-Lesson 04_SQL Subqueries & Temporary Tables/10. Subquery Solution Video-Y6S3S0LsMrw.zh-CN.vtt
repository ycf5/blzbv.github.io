WEBVTT
Kind: captions
Language: zh-CN

00:00:00.190 --> 00:00:04.310
由于我们讲到使用子查询进行更加复杂的查询

00:00:04.309 --> 00:00:07.309
课堂工作空间可能看起来有些狭促

00:00:07.309 --> 00:00:10.504
如果你还没有在编辑器中编写查询

00:00:10.505 --> 00:00:13.950
那么现在是开始的好时机 接下来是我的工作流程

00:00:13.949 --> 00:00:15.544
你可以看到在左边

00:00:15.544 --> 00:00:20.579
我的编辑器使用 subqueries.sql 扩展名打开

00:00:20.579 --> 00:00:23.299
然后右边的这个位置是课堂

00:00:23.300 --> 00:00:26.620
在那里我可以阅读问题并执行我的代码

00:00:26.620 --> 00:00:29.439
现在我们来看第一个问题

00:00:29.439 --> 00:00:32.284
第一个问题是

00:00:32.284 --> 00:00:36.709
请提供各个地区销售总额最大的销售代表的名字

00:00:36.710 --> 00:00:38.579
要解决这个问题

00:00:38.579 --> 00:00:41.614
我们首先可尝试拉取一些信息

00:00:41.615 --> 00:00:45.375
这个表给出的是销售代表信息

00:00:45.375 --> 00:00:47.450
这个表是区域信息

00:00:47.450 --> 00:00:50.780
美元总额在这里的订单表中

00:00:50.780 --> 00:00:53.270
因此需要将这四个表综合在一起

00:00:53.270 --> 00:00:56.949
以拉取这些信息

00:00:56.948 --> 00:00:59.599
那么我们开始

00:00:59.600 --> 00:01:30.109
首先是注释的起始标识

00:01:30.109 --> 00:01:46.289
好

00:01:46.290 --> 00:01:49.625
当我回头看的时候 它能使我更容易地找到这些东西

00:01:49.625 --> 00:01:52.424
接下来 继续解决这个问题

00:01:52.424 --> 00:01:59.478
把所有这些信息汇集在一起

00:01:59.478 --> 00:02:05.677
我们从销售代表表格开始

00:02:05.677 --> 00:02:11.312
将其别名标注为 sr 然后跟区域表联接

00:02:11.312 --> 00:02:13.450
区域表用别名 r 标注

00:02:13.449 --> 00:02:15.854
主键和外键匹配　然后联接

00:02:15.854 --> 00:02:24.444
那么 sr.region_id = r.id

00:02:24.444 --> 00:02:29.444
要拉取账户信息

00:02:29.444 --> 00:02:38.192
使用别名 a 那么就是 a.sales_rep_id = sr.id

00:02:38.193 --> 00:02:44.950
然后联接订单表

00:02:44.949 --> 00:02:52.457
o.account_id = a.id

00:02:52.457 --> 00:02:57.115
很好 现在我们把所有的信息都汇总到一起了

00:02:57.115 --> 00:03:01.000
从该查询可以看到 我们需要销售代表的姓名、区域名称

00:03:01.000 --> 00:03:06.310
以及每个代表的总销售额

00:03:06.310 --> 00:03:09.689
所以继续　把这些信息放在一起

00:03:09.689 --> 00:03:13.525
如果我们能汇总销售代表信息

00:03:13.525 --> 00:03:20.760
那么我们也可以汇总区域信息

00:03:20.759 --> 00:03:26.992
以及订单信息

00:03:26.992 --> 00:03:29.615
我们需要总金额

00:03:29.615 --> 00:03:37.275
和基本上每个代表的总金额

00:03:37.275 --> 00:03:42.155
销售总额 即 total_sales

00:03:42.155 --> 00:03:47.980
然后要对不在我们别名之列的东西进行分组

00:03:47.980 --> 00:03:49.590
别名在这里

00:03:49.590 --> 00:03:51.993
这两个列在它们之外

00:03:51.993 --> 00:03:54.014
那么分组条件是　1　2

00:03:54.014 --> 00:04:02.769
然后 ORDER BY 3 DESC

00:04:02.770 --> 00:04:04.430
让我们继续

00:04:04.430 --> 00:04:08.125
看看得到了什么

00:04:08.125 --> 00:04:10.969
很好

00:04:10.969 --> 00:04:12.802
执行完成

00:04:12.802 --> 00:04:15.514
可以看到我们只有一个名字列

00:04:15.514 --> 00:04:16.849
这可能是因为

00:04:16.850 --> 00:04:22.265
工作空间对于将这两列名称相同感到不解

00:04:22.264 --> 00:04:24.500
因此 我们可以使它们更加具体

00:04:24.500 --> 00:04:30.694
我们称之为rep_name和region_name

00:04:30.694 --> 00:04:37.298
这样再试一次

00:04:37.298 --> 00:04:38.644
很好

00:04:38.644 --> 00:04:40.475
现在出现的是三列

00:04:40.475 --> 00:04:43.470
包括销售代表名字、区域名称、总销售额

00:04:43.470 --> 00:04:44.915
但是这个问题

00:04:44.915 --> 00:04:47.300
要求我们提供的销售代表

00:04:47.300 --> 00:04:50.210
应该是各区域销售总额最大的那位

00:04:50.209 --> 00:04:54.409
所以从根本上说

00:04:54.410 --> 00:04:58.737
在东南地区 我们要的是这个人 东北地区我们要的是这个人

00:04:58.737 --> 00:04:59.870
但是这里还有另一个东南地区的销售代表

00:04:59.870 --> 00:05:03.699
但我们并不希望他出现在我们的表格里

00:05:03.699 --> 00:05:05.479
这位应该是西方区域总额最高的销售代表

00:05:05.480 --> 00:05:11.420
其他区域同理 我们只想看到相应的销售冠军

00:05:11.420 --> 00:05:17.345
要做到这一点

00:05:17.345 --> 00:05:21.095
需要进行稍微复杂的联接

00:05:21.095 --> 00:05:25.360
但这很常见

00:05:25.360 --> 00:05:31.335
从这里可以看到表格信息

00:05:31.334 --> 00:05:52.490
接下来我们要创建一个子查询

00:05:52.490 --> 00:05:55.050
暂且称它为 t1

00:05:55.050 --> 00:05:58.276
或者大家可以提出更好的命名规则

00:05:58.276 --> 00:06:02.039
我们想要从 t1 提取信息 然后要做的

00:06:02.040 --> 00:06:05.110
是选择地区

00:06:05.110 --> 00:06:11.725
对于每个地区 我们只想看到总销售额最大的销售代表

00:06:11.725 --> 00:06:21.689
所以从刚刚看到的右边这张表中

00:06:21.689 --> 00:06:27.540
我们将提取相应地区的最大总销售额

00:06:27.540 --> 00:06:31.035
由于已经对个人进行分组

00:06:31.035 --> 00:06:34.740
我们只需提取每个地区的最大销售额

00:06:34.740 --> 00:06:37.650
所以对于东南区域 应该提取这个数字

00:06:37.649 --> 00:06:40.259
对于东北区域 应该提取这个数字

00:06:40.259 --> 00:06:41.459
对于西部区域

00:06:41.459 --> 00:06:44.324
应该提取这个数字 以此类推

00:06:44.324 --> 00:06:46.349
可以看到东北区域

00:06:46.350 --> 00:06:48.195
应该提取这个最大额

00:06:48.194 --> 00:06:50.500
除了提取部分 其余都会消失

00:06:50.500 --> 00:06:53.670
遗憾的是 我们不能一蹴而就

00:06:53.670 --> 00:06:56.995
因为如果我们再次对个人进行分组

00:06:56.995 --> 00:06:59.610
那么该地区相应的个人仍然是独一无二的

00:06:59.610 --> 00:07:03.074
所以我们最终又会看到所有这些表值

00:07:03.074 --> 00:07:06.254
但如果只对地区分组

00:07:06.254 --> 00:07:11.153
我们应该只得到销售额最大的一个销售代表

00:07:11.153 --> 00:07:18.314
因此接下来我们应该这样来做

00:07:18.314 --> 00:07:28.480
这是该地区的最大销售额

00:07:28.480 --> 00:07:31.569
由于我们在这里有另一个聚合 我们需要对不在聚合内的东西进行分组

00:07:31.569 --> 00:07:33.298
这只是其一

00:07:33.298 --> 00:07:37.709
好 我们继续运行它 确保它是有效的

00:07:37.910 --> 00:07:43.285
很好 现在可以看到这四个地区

00:07:43.285 --> 00:07:46.540
前面提到东北区域的时候我出了一点差错 （导致出现两个东北区域）

00:07:46.540 --> 00:07:49.194
现在我们得到了四个地区以及各地区的最大销售额

00:07:49.194 --> 00:07:53.290
接下来我们将它与原来的表相结合

00:07:53.290 --> 00:07:55.825
与之前的表相结合

00:07:55.824 --> 00:07:59.664
匹配地区

00:07:59.665 --> 00:08:02.360
总销售额等于最大销售额

00:08:02.360 --> 00:08:03.995
我们继续

00:08:03.995 --> 00:08:06.069
我们得到这个表

00:08:06.069 --> 00:08:09.964
就是现在可以看到的位于右边的表

00:08:09.964 --> 00:08:12.174
现在要从这个表中提取信息

00:08:12.175 --> 00:08:17.912
暂称它为 t2

00:08:17.911 --> 00:08:23.370
从 t2 中进行提取

00:08:23.370 --> 00:08:28.625
然后联接下边这个表

00:08:28.625 --> 00:08:33.850
下面这个表

00:08:33.850 --> 00:08:37.615
暂称它为 t3

00:08:37.615 --> 00:08:40.878
右边这个表是 t2

00:08:40.878 --> 00:08:43.525
t3 是我们之前执行的表

00:08:43.524 --> 00:08:46.569
现在我们想要使最大销售额

00:08:46.570 --> 00:08:49.420
等于前表中的销售额

00:08:49.419 --> 00:08:51.219
然后从联接表中提取相应区域

00:08:51.220 --> 00:08:56.529
和销售代表

00:08:56.529 --> 00:08:58.129
现在进行选择

00:08:58.129 --> 00:09:02.004
实质上要提取的地区

00:09:02.004 --> 00:09:04.894
或者是否提取最大销售额或总销售额真的并不重要

00:09:04.894 --> 00:09:08.053
表格连接部分是关键所在

00:09:08.053 --> 00:09:13.029
从 t2 可以提取区域名称

00:09:13.029 --> 00:09:18.750
以及提取最大销售额

00:09:18.750 --> 00:09:23.576
然后从 t3 提取销售代表姓名

00:09:23.576 --> 00:09:30.240
我把它放在前面

00:09:30.240 --> 00:09:32.164
好

00:09:32.164 --> 00:09:35.389
这里就有了需要提取的三个部分

00:09:35.389 --> 00:09:42.314
接下来重要的是 如何将两个表连接起来

00:09:42.315 --> 00:09:45.645
上面这个表里有区域名称

00:09:45.644 --> 00:09:50.615
以及特定销售代表的最高销售额

00:09:50.615 --> 00:09:54.086
现在需要联接两表

00:09:54.086 --> 00:10:02.694
即 t2.region_name = t3.region_name

00:10:02.695 --> 00:10:10.004
然后是 t2 的最大销售量

00:10:10.004 --> 00:10:18.033
等于 t3 的总销售量

00:10:18.033 --> 00:10:23.200
如果区域匹配 就可以知道我们看到的是正确的区域

00:10:23.200 --> 00:10:25.645
如果最大销售额等于销售总额

00:10:25.644 --> 00:10:29.350
那么说明最大销售额

00:10:29.350 --> 00:10:34.284
等于我们看到的第一个表里特定销售代表的销售额

00:10:34.284 --> 00:10:37.360
因此

00:10:37.360 --> 00:10:43.705
仅提取销售额等于最大销售额的销售代表

00:10:43.705 --> 00:10:45.810
以及他们所在的区域

00:10:45.809 --> 00:10:49.689
可以看到 东南地区的销售额最高

00:10:49.690 --> 00:10:52.790
那么可能指向相应的销售代表

00:10:52.789 --> 00:10:55.314
如果没有对地区进行匹配

00:10:55.315 --> 00:11:01.453
我们会得到中西部区域的多个最大销售额

00:11:01.452 --> 00:11:03.366
但不是该地区的最大销售额

00:11:03.366 --> 00:11:04.704
这是该地区的最大销售额

00:11:04.705 --> 00:11:08.960
因此我们连接两个地区和销售额

00:11:08.960 --> 00:11:15.556
然后运行

00:11:15.556 --> 00:11:18.759
好

00:11:18.759 --> 00:11:21.480
可以看到我们得到四个结果

00:11:21.480 --> 00:11:23.700
包括东南、东北

00:11:23.700 --> 00:11:24.855
西部和中西部区域

00:11:24.855 --> 00:11:25.980
其它则消失不见

00:11:25.980 --> 00:11:27.500
这是四个区域

00:11:27.500 --> 00:11:30.029
这是特定销售代表的最大销售额

00:11:30.029 --> 00:11:33.789
这是销售代表的名字

